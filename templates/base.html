<!DOCTYPE html>
<html lang="pt-pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% load pwa static auth_extras %}
    <title>{% block title %}Minha Contabilidade{% endblock %}</title>

    <!-- PWA Meta -->
    {% progressive_web_app_meta %}

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.2.3/css/flag-icons.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=8" />
  </head>
  <body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <a href="/" class="brand">
        <img src="{% static 'images/icon-160x160.png' %}?v=2" alt="Logo" />
        ContabileX
      </a>
      {% spaceless %}
      <div class="nav-links" role="list">
        <div class="nav-item" role="listitem">
          <a href="/" class="nav-link {% if request.path == '/' %}active{% endif %}">
            <i class="fas fa-home"></i> <span>Dashboard</span>
          </a>
        </div>
        
        {% if user|has_group:"Comercial" %}
        <div class="nav-module {% if '/clientes/' in request.path or '/faturas/' in request.path or '/compras/' in request.path or '/fornecedores/' in request.path or '/contas-correntes/' in request.path %}expanded{% endif %}" role="listitem">
            <div class="nav-module-title">Comercial<i class="fas fa-chevron-down text-xs"></i></div>
            <div class="nav-module-content" role="list">
                <div class="nav-item" role="listitem"><a href="/faturas/" class="nav-link {% if '/faturas/' in request.path %}active{% endif %}"><i class="fas fa-file-invoice-dollar"></i> Faturação</a></div>
                <div class="nav-item" role="listitem"><a href="/clientes/" class="nav-link {% if request.path == '/clientes/' %}active{% endif %}"><i class="fas fa-users"></i> Clientes</a></div>
                <div class="nav-item" role="listitem"><a href="/compras/" class="nav-link {% if '/compras/' in request.path %}active{% endif %}"><i class="fas fa-shopping-cart"></i> Compras</a></div>
                <div class="nav-item" role="listitem"><a href="/fornecedores/" class="nav-link {% if request.path == '/fornecedores/' %}active{% endif %}"><i class="fas fa-truck"></i> Fornecedores</a></div>
                <div class="nav-item" role="listitem"><a href="{% url 'contas_correntes_list' %}" class="nav-link {% if '/contas-correntes/' in request.path %}active{% endif %}"><i class="fas fa-balance-scale"></i> Contas Correntes</a></div>
            </div>
        </div>
        {% endif %}

        {% if user|has_group:"Contabilidade" %}
        <div class="nav-module {% if '/despesas/' in request.path or '/diario/' in request.path or '/plano-contas/' in request.path or '/relatorios/' in request.path %}expanded{% endif %}" role="listitem">
            <div class="nav-module-title">Contabilidade<i class="fas fa-chevron-down text-xs"></i></div>
            <div class="nav-module-content" role="list">
                <div class="nav-item" role="listitem"><a href="/despesas/" class="nav-link {% if request.path == '/despesas/' %}active{% endif %}"><i class="fas fa-receipt"></i> Despesas Gerais</a></div>
                <div class="nav-item" role="listitem"><a href="/diario/lancamentos/" class="nav-link {% if '/diario/' in request.path %}active{% endif %}"><i class="fas fa-book"></i> Diário Geral</a></div>
                <div class="nav-item" role="listitem"><a href="/plano-contas/" class="nav-link {% if '/plano-contas/' in request.path %}active{% endif %}"><i class="fas fa-list-ol"></i> Plano de Contas</a></div>
                <div class="nav-item" role="listitem"><a href="/relatorios/" class="nav-link {% if '/relatorios/' in request.path and 'retencoes' not in request.path %}active{% endif %}"><i class="fas fa-chart-line"></i> {% if r.lang == 'en' %}Accounting Reports{% else %}Relatórios PGC{% endif %}</a></div>
                <div class="nav-item" role="listitem"><a href="{% url 'relatorio_retencoes' %}" class="nav-link {% if 'retencoes' in request.path %}active{% endif %}"><i class="fas fa-file-contract"></i> {{ r.mapa_fiscal }}</a></div>
                <div class="nav-item" role="listitem"><a href="{% url 'taxas_imposto_list' %}" class="nav-link {% if '/contabilidade/taxas/' in request.path %}active{% endif %}"><i class="fas fa-percent"></i> Taxas de Imposto</a></div>
            </div>
        </div>
        {% endif %}

        {% if user|has_group:"Stocks" %}
        <div class="nav-module {% if '/stock/' in request.path %}expanded{% endif %}" role="listitem">
            <div class="nav-module-title">Stocks<i class="fas fa-chevron-down text-xs"></i></div>
            <div class="nav-module-content" role="list">
                <div class="nav-item" role="listitem"><a href="{% url 'produtos_list' %}" class="nav-link {% if '/stock/produtos/' in request.path %}active{% endif %}"><i class="fas fa-boxes"></i> Produtos</a></div>
                <div class="nav-item" role="listitem"><a href="{% url 'movimentos_stock_list' %}" class="nav-link {% if '/stock/movimentos/' in request.path %}active{% endif %}"><i class="fas fa-exchange-alt"></i> Movimentos</a></div>
                <div class="nav-item" role="listitem"><a href="{% url 'inventarios_list' %}" class="nav-link {% if '/stock/inventarios/' in request.path %}active{% endif %}"><i class="fas fa-clipboard-check"></i> Inventários</a></div>
            </div>
        </div>
        {% endif %}

        {% if user|has_group:"Recursos Humanos" %}
        <div class="nav-module {% if '/rh/' in request.path %}expanded{% endif %}" role="listitem">
            <div class="nav-module-title">Recursos Humanos<i class="fas fa-chevron-down text-xs"></i></div>
            <div class="nav-module-content" role="list">
                <div class="nav-item" role="listitem"><a href="{% url 'funcionarios_list' %}" class="nav-link {% if '/rh/funcionarios/' in request.path %}active{% endif %}"><i class="fas fa-users-gear"></i> Funcionários</a></div>
                <div class="nav-item" role="listitem"><a href="{% url 'processamento_rh' %}" class="nav-link {% if '/rh/processamento/' in request.path %}active{% endif %}"><i class="fas fa-money-check-dollar"></i> Processamento Salarial</a></div>
                <div class="nav-item" role="listitem"><a href="{% url 'lancamentos_rh_list' %}" class="nav-link {% if '/rh/lancamentos/' in request.path %}active{% endif %}"><i class="fas fa-clock"></i> Assiduidade & Horas</a></div>
                <div class="nav-item" role="listitem"><a href="{% url 'tabela_irt' %}" class="nav-link {% if '/rh/irt/' in request.path %}active{% endif %}"><i class="fas fa-table"></i> Tabela IRT</a></div>
            </div>
        </div>
        {% endif %}

        {% if user|has_group:"Administração" %}
        <div class="nav-module {% if '/configuracao/' in request.path %}expanded{% endif %}" role="listitem">
            <div class="nav-module-title">Administração<i class="fas fa-chevron-down text-xs"></i></div>
            <div class="nav-module-content" role="list">
                <div class="nav-item" role="listitem"><a href="{% url 'usuarios_list' %}" class="nav-link {% if '/configuracao/usuarios/' in request.path %}active{% endif %}"><i class="fas fa-user-shield"></i> Utilizadores</a></div>
                <div class="nav-item" role="listitem"><a href="{% url 'configuracao_empresa' %}" class="nav-link {% if '/configuracao/' in request.path and '/usuarios/' not in request.path %}active{% endif %}"><i class="fas fa-cog"></i> Configurações</a></div>
            </div>
        </div>
        {% endif %}
      </div>
      {% endspaceless %}

      <div class="sidebar-footer">
        <form action="{% url 'logout' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="btn-logout-sidebar">
                <i class="fas fa-sign-out-alt"></i> <span>Sair</span>
            </button>
        </form>
      </div>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="main-content">
      <!-- Top Header -->
      <header class="top-header">
        <div class="header-title">
          <button id="toggleSidebar" class="btn btn-icon mr-4 md-hide" title="Alternar Menu Sidebar"><i class="fas fa-bars"></i></button>
          <div class="flex flex-col">
            <h1 class="text-lg font-bold">{% block page_title %}{% endblock %}</h1>
            <div class="text-xs text-secondary">Bem-vindo, <strong>{{ user.username }}</strong></div>
          </div>
        </div>

        <div class="flex items-center gap-4">
          {% block header_actions %}{% endblock %}
          <!-- Seletor de Empresa -->
          <div class="dropdown dropdown-container">
            <button class="btn btn-premium-secondary border-muted flex items-center gap-2" onclick="document.getElementById('companyDropdown').classList.toggle('show')">
              <i class="fas fa-building text-blue"></i>
              <span class="font-semibold">{{ active_empresa.nome|default:"Selecionar Empresa" }}</span>
              <span class="fi fi-{{ active_empresa.pais|lower }} rounded-8"></span>
              <i class="fas fa-chevron-down text-xs ml-2"></i>
            </button>
            <div id="companyDropdown" class="dropdown-content-base shadow-lg z-dropdown">
              <div class="dropdown-header">ESCOLHER EMPRESA</div>
              {% for emp in todas_empresas %}
              <a href="{% url 'selecionar_empresa' emp.pk %}" class="dropdown-item {% if emp == active_empresa %}active{% endif %} flex items-center gap-3">
                <span class="fi fi-{{ emp.pais|lower }} rounded-8"></span>
                <span>{{ emp.nome }}</span>
              </a>
              {% endfor %}
              <div class="dropdown-footer">
                <a href="{% url 'configuracao_empresa' %}">
                  <i class="fas fa-cog"></i> Configurações
                </a>
              </div>
            </div>
          </div>

          <div class="user-profile">
            <button class="btn btn-icon" title="Ver Notificações"><i class="fas fa-bell"></i></button>
            <div class="dropdown dropdown-container">
               <div class="avatar cursor-pointer" onclick="document.getElementById('userDropdown').classList.toggle('show')" title="Menu do Utilizador">{{ user.username|first|upper }}</div>
               <div id="userDropdown" class="dropdown-content-base shadow-lg z-dropdown">
                  <div class="dropdown-user-info">
                      <div class="font-semibold text-sm">{{ user.username }}</div>
                      <div class="text-xs text-secondary">{{ user.email }}</div>
                  </div>
                  <form action="{% url 'logout' %}" method="post" class="m-0">
                      {% csrf_token %}
                      <button type="submit" class="dropdown-item w-full text-left bg-none cursor-pointer text-danger">
                          <i class="fas fa-sign-out-alt"></i> <span>Sair</span>
                      </button>
                  </form>
               </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Dynamic Content -->
      <main class="content-wrapper">
        {% if messages %}
        <div class="messages-container">
            {% for message in messages %}
            <div class="alert-base alert-{{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% block content %} {% endblock %}
      </main>
    </div>

    <!-- Offline Status Indicator -->
    <div id="connection-status" class="connection-indicator status-online d-none">
      Online
    </div>

    <script src="{% static 'js/main.js' %}"></script>
    <script>
      // Dropdown Toggle
      window.onclick = function(event) {
        if (!event.target.closest('.dropdown')) {
          var dropdowns = document.getElementsByClassName("dropdown-content-base");
          for (var i = 0; i < dropdowns.length; i++) {
            var openDropdown = dropdowns[i];
            if (openDropdown.classList.contains('show')) {
              openDropdown.classList.remove('show');
            }
          }
        }
      }
      
      // Sidebar Toggle Mobile
      const btnToggle = document.getElementById('toggleSidebar');
      const sidebar = document.getElementById('sidebar');
      if(btnToggle) {
          btnToggle.onclick = () => sidebar.classList.toggle('mobile-show');
      }

      // Connectivity
      window.addEventListener('online', () => {
          const indicator = document.getElementById('connection-status');
          indicator.classList.remove('d-none');
          indicator.classList.add('status-online');
          indicator.textContent = 'Online';
          setTimeout(() => indicator.classList.add('d-none'), 3000);
      });

      window.addEventListener('offline', () => {
          const indicator = document.getElementById('connection-status');
          indicator.classList.remove('d-none');
          indicator.classList.remove('status-online');
          indicator.classList.add('status-offline');
          indicator.textContent = 'O sistema está offline';
      });

      // Navigation Modules
      document.querySelectorAll('.nav-module-title').forEach(title => {
          title.onclick = () => {
              title.parentElement.classList.toggle('expanded');
          }
      });
    </script>
  </body>
</html>
