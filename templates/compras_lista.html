{% extends 'base.html' %} {% block title %} Compras - ContabileX {% endblock %}
{% block page_title %} Compras {% endblock %} {% block content %}
<div class="header-actions">
  <div>
    <h3>Documentos de Compra</h3>
    <p class="text-secondary small">
      Consulte e gira todas as suas compras e faturas de fornecedores.
    </p>
  </div>
  <a href="{% url 'nova_compra' %}" class="btn btn-premium-accent btn-icon-only" title="Nova Compra">
    <i class="fas fa-plus"></i>
  </a>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Número</th>


        
        <th>Data</th>
        <th>Fornecedor</th>
        <th>Ref. Fornecedor</th>
        <th>Estado</th>
        <th>Total</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for compra in compras %}
      <tr>
        <td>
          <a href="{% url 'compra_detalhe' compra.id %}" class="text-none">
            <span class="badge badge-code">{{ compra.numero }}</span>
          </a>
        </td>
        <td>{{ compra.data_emissao|date:"d/m/Y" }}</td>
        <td class="font-medium">{{ compra.fornecedor.nome }}</td>
        <td>{{ compra.referencia_fornecedor|default:"-" }}</td>
        <td>
          {% if compra.estado == 'RASCUNHO' %}
          <span class="badge badge-gray">Rascunho</span>
          {% elif compra.estado == 'REGISTADA' %}
          <span class="badge badge-blue">Registada</span>
          {% elif compra.estado == 'PAGAMENTO_PARCIAL' %}
          <span class="badge badge-gray-blue">Parcial</span>
          {% elif compra.estado == 'PAGA' %}
          <span class="badge badge-green">Paga</span>
          {% else %}
          <span class="badge badge-red">Anulada</span>
          {% endif %}
        </td>
        <td class="text-right">
          <div class="font-bold">{{ active_empresa.moeda_simbolo }} {{ compra.total|floatformat:2 }}</div>
          <div class="small text-secondary">
            {{ active_empresa.moeda_estrangeira }} {{ compra.total_estrangeiro|floatformat:2 }}
          </div>
        </td>
        <td class="flex gap-1">
          <a href="{% url 'compra_detalhe' compra.id %}" class="btn btn-premium-secondary btn-table-action" title="Ver Detalhes Contabilísticos">
            <i class="fas fa-search"></i>
          </a>
          {% if compra.estado == 'RASCUNHO' %}
          <a href="{% url 'mudar_estado_compra' compra.id 'REGISTADA' %}" class="btn btn-premium-success btn-table-action" title="Validar/Registar Compra">
            <i class="fas fa-check-circle"></i>
          </a>
          {% endif %}

          {% if compra.estado == 'REGISTADA' %}
          <a href="{% url 'mudar_estado_compra' compra.id 'PAGA' %}" class="btn btn-premium-success btn-table-action" title="Marcar como Pago">
            <i class="fas fa-money-bill-wave"></i>
          </a>
          {% endif %}

          {% if compra.estado != 'ANULADA' and compra.estado != 'PAGA' %}
          <a href="{% url 'mudar_estado_compra' compra.id 'ANULADA' %}" class="btn btn-premium-danger btn-table-action" title="Anular Compra" onclick="return confirm('Tem a certeza que deseja anular este registo de compra?')">
            <i class="fas fa-times-circle"></i>
          </a>
          {% endif %}
        </td>
      </tr>
      {% empty %}
        <td colspan="6" class="text-center py-8 text-secondary">
          Nenhuma compra registada ainda.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
