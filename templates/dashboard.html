{% extends 'base.html' %}

{% block title %}
Dashboard - ContabileX
{% endblock %}

{% block page_title %}
Dashboard
{% endblock %}

{% block content %}
<style>
    .dashboard-section-title {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        margin: 2rem 0 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .grid-4 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    .stat-card {
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .border-success { border-bottom: 3px solid var(--success-color) !important; }
    .border-danger { border-bottom: 3px solid var(--danger-color) !important; }
</style>

<!-- Câmbio do Dia (BNA) -->
<div class="flex gap-4 mb-4 bg-glass-dark py-3 px-6 rounded-full border-glass items-center w-fit">
    <span class="small font-semibold text-secondary mr-2 uppercase">Câmbio BNA (Ref):</span>
    
    <div class="currency-badge pr-4 border-r">
        <img src="https://flagcdn.com/w20/us.png" width="16" height="12" alt="USD">
        <span class="font-semibold font-mono">USD: {{ bna_rates.USD }}</span>
    </div>

    <div class="currency-badge pl-2">
        <img src="https://flagcdn.com/w20/eu.png" width="16" height="12" alt="EUR">
        <span class="font-semibold font-mono">EUR: {{ bna_rates.EUR }}</span>
    </div>

    <a href="{% url 'atualizar_cambios' %}" class="ml-4 small text-secondary text-none cursor-pointer" title="Clique para atualizar">
        <i class="fas fa-sync-alt"></i> Atualizado via bna.ao
    </a>
</div>

<!-- Secção 1: Performance (Proveitos e Custos) -->
<div class="dashboard-section-title">
    <i class="fas fa-chart-line"></i>
    Performance Financeira (Regime de Competência)
</div>
<div class="grid-4">
    <div class="card stat-card">
        <div class="stat-header">
            <span class="stat-title">Proveitos Totais</span>
            <i class="fas fa-arrow-trend-up stat-icon badge-green"></i>
        </div>
        <div class="stat-value">{{ active_empresa.moeda_simbolo }} {{ proveitos_total|floatformat:2 }}</div>
        <div class="stat-change positive">
            <i class="fas fa-check-circle"></i>
            <span>Faturação Reconhecida</span>
        </div>
    </div>

    <div class="card stat-card">
        <div class="stat-header">
            <span class="stat-title">Custos e Gastos</span>
            <i class="fas fa-arrow-trend-down stat-icon badge-red"></i>
        </div>
        <div class="stat-value">{{ active_empresa.moeda_simbolo }} {{ custos_total|floatformat:2 }}</div>
        <div class="stat-change">
            <i class="fas fa-file-invoice-dollar"></i>
            <span>Compras e Despesas</span>
        </div>
    </div>

    <div class="card stat-card {% if resultado_estimado >= 0 %}border-success{% else %}border-danger{% endif %}">
        <div class="stat-header">
            <span class="stat-title">Resultado Estimado</span>
            <i class="fas fa-scale-balanced stat-icon badge-secondary"></i>
        </div>
        <div class="stat-value">{{ active_empresa.moeda_simbolo }} {{ resultado_estimado|floatformat:2 }}</div>
        <div class="stat-change {% if resultado_estimado >= 0 %}positive{% else %}negative{% endif %}">
            {% if resultado_estimado >= 0 %}
                <i class="fas fa-smile"></i>
                <span>Superavitário</span>
            {% else %}
                <i class="fas fa-frown"></i>
                <span>Défice</span>
            {% endif %}
        </div>
    </div>

    <div class="card stat-card">
        <div class="stat-header">
            <span class="stat-title">Margem Bruta (Est.)</span>
            <i class="fas fa-percentage stat-icon badge-blue"></i>
        </div>
        <div class="stat-value">
            {{ margem_bruta|floatformat:1 }}%
        </div>
        <div class="stat-change">
            <i class="fas fa-chart-pie"></i>
            <span>Rentabilidade</span>
        </div>
    </div>
</div>

<!-- Secção 2: Tesouraria e Terceiros -->
<div class="dashboard-section-title">
    <i class="fas fa-university"></i>
    Tesouraria e Balanço de Terceiros
</div>
<div class="grid-4">
    <div class="card stat-card">
        <div class="stat-header">
            <span class="stat-title">Disponibilidades (Bancos)</span>
            <i class="fas fa-building-columns stat-icon badge-blue"></i>
        </div>
        <div class="stat-value text-blue">Kz {{ saldo_bancos|floatformat:2 }}</div>
        <div class="stat-change">
            <i class="fas fa-clock"></i>
            <span>Saldo Atual (Classe 43)</span>
        </div>
    </div>

    <div class="card stat-card">
        <div class="stat-header">
            <span class="stat-title">Caixa (Físico)</span>
            <i class="fas fa-money-bill-1-wave stat-icon badge-green"></i>
        </div>
        <div class="stat-value">Kz {{ saldo_caixa|floatformat:2 }}</div>
        <div class="stat-change">
            <i class="fas fa-coins"></i>
            <span>Saldo em Mão (Classe 45)</span>
        </div>
    </div>

    <div class="card stat-card">
        <div class="stat-header">
            <span class="stat-title">A Receber (Clientes)</span>
            <i class="fas fa-hand-holding-dollar stat-icon badge-blue"></i>
        </div>
        <div class="stat-value">Kz {{ saldo_clientes|floatformat:2 }}</div>
        <div class="stat-change positive">
            <i class="fas fa-users"></i>
            <span>Pendentes (Classe 31)</span>
        </div>
    </div>

    <div class="card stat-card">
        <div class="stat-header">
            <span class="stat-title">A Pagar (Fornecedores)</span>
            <i class="fas fa-file-invoice stat-icon badge-red"></i>
        </div>
        <div class="stat-value text-danger">Kz {{ saldo_fornecedores|floatformat:2 }}</div>
        <div class="stat-change">
            <i class="fas fa-truck"></i>
            <span>Dívidas (Classe 32)</span>
        </div>
    </div>
</div>

<div class="charts-section mt-8">
    <div class="card">
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-lg"><i class="fas fa-file-invoice mr-2 text-blue"></i>Últimas Faturas</h3>
            <a href="{% url 'faturas_list' %}" class="small text-blue text-none">Ver todas</a>
        </div>
        {% if ultimas_faturas %}<div class="dashboard-list" role="list">{% for fatura in ultimas_faturas %}<div class="dashboard-list-item" role="listitem"><div><div class="font-semibold">{{ fatura.numero }}</div><div class="small text-secondary">{{ fatura.cliente.nome }}</div></div><div class="text-right"><div class="text-success font-semibold">Kz {{ fatura.total|floatformat:2 }}</div><div class="small opacity-60">{{ fatura.data_emissao|date:"d M" }}</div></div></div>{% endfor %}</div>{% else %}<div class="text-center py-8 text-secondary">Nenhuma fatura emitida ainda</div>{% endif %}
    </div>
    
    <div class="card">
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-lg"><i class="fas fa-receipt mr-2 text-danger"></i>Últimas Despesas</h3>
            <a href="{% url 'despesas' %}" class="small text-blue text-none">Ver todas</a>
        </div>
        {% if ultimas_despesas %}<div class="dashboard-list" role="list">{% for despesa in ultimas_despesas %}<div class="dashboard-list-item" role="listitem"><div><div class="font-semibold">{{ despesa.numero }}</div><div class="small text-secondary">{{ despesa.descricao }}</div></div><div class="text-right"><div class="text-danger font-semibold">Kz {{ despesa.valor|floatformat:2 }}</div><div class="small opacity-60">{{ despesa.data|date:"d M" }}</div></div></div>{% endfor %}</div>{% else %}<div class="text-center py-8 text-secondary">Nenhuma despesa registada ainda</div>{% endif %}
    </div>
</div>

<div class="card mt-8 border-dashed bg-none">
    <h3 class="mb-4 small font-semibold"><i class="fas fa-bolt mr-2 text-secondary"></i>Atalhos de Gestão</h3>
    <div class="grid grid-cols-4 gap-4">
        <a href="{% url 'nova_fatura' %}" class="btn btn-primary flex items-center justify-center gap-2 text-none">
            <i class="fas fa-plus"></i> Faturar
        </a>
        <a href="{% url 'novo_lancamento' %}" class="btn btn-premium-secondary flex items-center justify-center gap-2 text-none">
            <i class="fas fa-book"></i> Lançamento Manual
        </a>
        <a href="{% url 'relatorios_menu' %}" class="btn btn-premium-accent flex items-center justify-center gap-2 text-none">
            <i class="fas fa-file-lines"></i> Relatórios PGC
        </a>
        <a href="{% url 'configuracao_empresa' %}" class="btn btn-premium-secondary border-secondary flex items-center justify-center gap-2 text-none">
            <i class="fas fa-gears"></i> Definições
        </a>
    </div>
</div>
{% endblock %}
